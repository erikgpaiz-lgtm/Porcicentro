<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRM — PorciCentro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Barlow:wght@300;400;500;600;700&family=Barlow+Condensed:wght@500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--r:#B8001A;--rv:#E0001F;--ro:rgba(184,0,26,.08);--gold:#D4920A;--negro:#0A0A0A;--carbon:#141414;--gris-d:#252525;--gris:#666;--gris-m:#999;--gris-l:#EDE9E3;--crema:#FAF7F2;--verde:#1A6B3A;--fh:'Playfair Display',serif;--fb:'Barlow',sans-serif;--fc:'Barlow Condensed',sans-serif;}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{font-size:16px;scroll-behavior:smooth}
body{font-family:var(--fb);background:var(--carbon);color:#fff;overflow-x:hidden;-webkit-font-smoothing:antialiased}
input,select,textarea,button{font-family:inherit}
button{cursor:pointer;border:none;background:none}
a{text-decoration:none;color:inherit}
ul{list-style:none}
::selection{background:var(--r);color:#fff}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--carbon)}::-webkit-scrollbar-thumb{background:var(--r);border-radius:3px}

/* ── LOGIN SCREEN ── */
#login-screen{position:fixed;inset:0;z-index:9999;background:var(--negro);display:flex;align-items:center;justify-content:center;padding:24px;transition:opacity .4s}
#login-screen.out{opacity:0;pointer-events:none}
.login-box{width:100%;max-width:420px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:24px;padding:48px;text-align:center}
.login-logo{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:32px}
.lm{width:40px;height:40px;border-radius:8px;background:var(--r);display:flex;align-items:center;justify-content:center;font-family:var(--fc);font-size:.75rem;font-weight:800;color:#fff;letter-spacing:.5px}
.lw{font-family:var(--fc);font-weight:800;font-size:1.2rem;letter-spacing:3px;text-transform:uppercase;color:#fff}
.lw em{color:var(--r);font-style:normal}
.login-title{font-family:var(--fh);font-size:1.6rem;font-weight:700;margin-bottom:6px}
.login-sub{font-size:.85rem;color:rgba(255,255,255,.35);margin-bottom:32px}
.lf{display:flex;flex-direction:column;gap:6px;margin-bottom:16px;text-align:left}
.lf label{font-family:var(--fc);font-size:.65rem;letter-spacing:2.5px;text-transform:uppercase;color:rgba(255,255,255,.35);font-weight:700}
.lf input{background:rgba(255,255,255,.05);border:1.5px solid rgba(255,255,255,.08);border-radius:10px;padding:13px 16px;color:#fff;font-size:.95rem;outline:none;transition:border-color .2s;width:100%}
.lf input:focus{border-color:var(--r)}
.lf input::placeholder{color:rgba(255,255,255,.2)}
.login-btn{width:100%;background:var(--r);color:#fff;font-family:var(--fc);font-size:.78rem;letter-spacing:2px;text-transform:uppercase;font-weight:700;padding:14px;border-radius:10px;border:none;cursor:pointer;transition:all .2s;margin-top:8px;display:flex;align-items:center;justify-content:center;gap:8px}
.login-btn:hover{background:var(--rv);transform:translateY(-1px);box-shadow:0 8px 24px rgba(184,0,26,.35)}
.login-btn:disabled{opacity:.6;pointer-events:none}
.login-err{color:#ff6b6b;font-size:.8rem;margin-top:8px;display:none}
.login-spinner{display:none;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ── LAYOUT ── */
#app{display:none;min-height:100vh}
#app.on{display:flex}
.sidebar{width:240px;flex-shrink:0;background:rgba(0,0,0,.45);border-right:1px solid rgba(255,255,255,.05);display:flex;flex-direction:column;position:fixed;top:0;bottom:0;left:0;z-index:100;overflow-y:auto;transition:transform .3s ease}
.sb-logo{padding:24px 20px;border-bottom:1px solid rgba(255,255,255,.05);display:flex;align-items:center;gap:10px;flex-shrink:0}
.sb-lm{width:32px;height:32px;border-radius:6px;background:var(--r);display:flex;align-items:center;justify-content:center;font-family:var(--fc);font-size:.62rem;font-weight:800;color:#fff}
.sb-lw{font-family:var(--fc);font-weight:800;font-size:.95rem;letter-spacing:2px;text-transform:uppercase}
.sb-lw em{color:var(--r);font-style:normal}
.sb-nav{flex:1;padding:16px 12px;display:flex;flex-direction:column;gap:3px}
.sb-label{font-family:var(--fc);font-size:.58rem;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,.2);padding:14px 10px 6px;font-weight:700}
.sb-link{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;font-family:var(--fc);font-size:.78rem;font-weight:600;letter-spacing:.5px;color:rgba(255,255,255,.42);transition:all .2s;cursor:pointer;border:none;background:none;width:100%;text-align:left}
.sb-link svg{width:17px;height:17px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0}
.sb-link:hover{background:rgba(255,255,255,.05);color:rgba(255,255,255,.75)}
.sb-link.active{background:rgba(184,0,26,.15);color:#fff;border-left:2.5px solid var(--r);border-radius:0 8px 8px 0;margin-left:-12px;padding-left:22px}
.sb-ft{padding:16px 20px;border-top:1px solid rgba(255,255,255,.05);flex-shrink:0}
.sb-user{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.sb-avatar{width:34px;height:34px;border-radius:50%;background:var(--r);display:flex;align-items:center;justify-content:center;font-family:var(--fh);font-size:.9rem;font-weight:700;color:#fff}
.sb-uname{font-family:var(--fc);font-size:.82rem;font-weight:700;color:rgba(255,255,255,.75)}
.sb-urole{font-size:.72rem;color:rgba(255,255,255,.3)}
.logout-btn{display:flex;align-items:center;gap:7px;font-family:var(--fc);font-size:.7rem;letter-spacing:1.5px;text-transform:uppercase;color:rgba(255,255,255,.3);transition:color .2s;cursor:pointer}
.logout-btn:hover{color:var(--r)}
.logout-btn svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2}

.main{flex:1;margin-left:240px;display:flex;flex-direction:column;min-height:100vh}
.topbar{padding:0 28px;height:62px;border-bottom:1px solid rgba(255,255,255,.05);display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,.2);flex-shrink:0}
.topbar-left{display:flex;align-items:center;gap:12px}
.topbar-title{font-family:var(--fc);font-size:1.1rem;font-weight:700;letter-spacing:.5px}
.topbar-actions{display:flex;gap:10px}
.page-content{flex:1;padding:32px 28px;overflow-y:auto}

/* Mobile hamburger */
.mob-toggle{display:none;width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,.06);align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.mob-toggle svg{width:20px;height:20px;stroke:#fff;fill:none;stroke-width:2;stroke-linecap:round}
.sb-overlay{display:none;position:fixed;inset:0;z-index:90;background:rgba(0,0,0,.6);backdrop-filter:blur(3px)}

/* ── GENERAL COMPONENTS ── */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;font-family:var(--fc);font-size:.7rem;letter-spacing:1.5px;text-transform:uppercase;font-weight:700;padding:10px 18px;border-radius:8px;border:1.5px solid transparent;transition:all .2s;cursor:pointer;white-space:nowrap}
.btn svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round}
.btn-prim{background:var(--r);color:#fff;border-color:var(--r)}.btn-prim:hover{background:var(--rv);transform:translateY(-1px)}
.btn-sec{background:rgba(255,255,255,.06);color:rgba(255,255,255,.7);border-color:rgba(255,255,255,.08)}.btn-sec:hover{background:rgba(255,255,255,.1);color:#fff}
.btn-danger{background:rgba(220,50,50,.15);color:#ff6b6b;border-color:rgba(220,50,50,.2)}.btn-danger:hover{background:rgba(220,50,50,.25)}
.btn-suc{background:rgba(26,107,58,.15);color:#4ADE80;border-color:rgba(26,107,58,.2)}
.btn-sm{padding:6px 12px;font-size:.63rem}

.card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:16px;padding:24px}
.card-sm{padding:16px}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px}
.stat-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:20px;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--r)}
.sc-val{font-family:var(--fh);font-size:1.8rem;font-weight:900;color:#fff;line-height:1;margin-bottom:4px}
.sc-lbl{font-family:var(--fc);font-size:.62rem;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.3)}
.sc-trend{position:absolute;top:18px;right:18px;font-family:var(--fc);font-size:.65rem;font-weight:700;padding:3px 8px;border-radius:100px}
.trend-up{background:rgba(26,107,58,.2);color:#4ADE80}
.trend-new{background:rgba(184,0,26,.2);color:#ff8a8a}

/* TABLE */
.tbl-wrap{overflow-x:auto;border-radius:12px;border:1px solid rgba(255,255,255,.06)}
.tbl{width:100%;border-collapse:collapse}
.tbl th{background:rgba(0,0,0,.3);padding:12px 16px;text-align:left;font-family:var(--fc);font-size:.62rem;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.3);font-weight:700;white-space:nowrap}
.tbl td{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.04);font-size:.88rem;vertical-align:middle}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:rgba(255,255,255,.02)}
.badge{display:inline-flex;align-items:center;gap:4px;font-family:var(--fc);font-size:.6rem;letter-spacing:1px;text-transform:uppercase;font-weight:700;padding:3px 9px;border-radius:100px}
.badge-ok{background:rgba(26,107,58,.18);color:#4ADE80}
.badge-warn{background:rgba(212,146,10,.18);color:#F5C842}
.badge-hot{background:rgba(184,0,26,.18);color:#ff8a8a}
.badge-new{background:rgba(37,211,102,.12);color:#25D366}

/* MODAL */
.modal-bg{position:fixed;inset:0;z-index:800;background:rgba(0,0,0,.72);backdrop-filter:blur(5px);display:flex;align-items:flex-start;justify-content:center;padding:32px 16px;overflow-y:auto;opacity:0;pointer-events:none;transition:opacity .3s}
.modal-bg.on{opacity:1;pointer-events:all}
.modal{background:#1a1a1a;border:1px solid rgba(255,255,255,.08);border-radius:20px;width:100%;max-width:580px;margin:auto;padding:36px;transform:translateY(20px) scale(.97);transition:all .35s cubic-bezier(.25,.8,.25,1)}
.modal-bg.on .modal{transform:none}
.modal-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px}
.modal-title{font-family:var(--fh);font-size:1.3rem;font-weight:700}
.modal-close{width:32px;height:32px;border-radius:8px;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.5);transition:all .2s}
.modal-close:hover{background:var(--r);color:#fff}
.fg{display:flex;flex-direction:column;gap:6px;margin-bottom:16px}
.fg label{font-family:var(--fc);font-size:.63rem;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.35);font-weight:700}
.fg input,.fg select,.fg textarea{background:rgba(255,255,255,.05);border:1.5px solid rgba(255,255,255,.07);border-radius:9px;padding:11px 14px;color:#fff;font-size:.9rem;outline:none;transition:border-color .2s;width:100%}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--r)}
.fg input::placeholder,.fg textarea::placeholder{color:rgba(255,255,255,.2)}
.fg select option{background:#1a1a1a}
.fg textarea{resize:vertical;min-height:80px}
.fg-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.modal-ft{display:flex;gap:10px;justify-content:flex-end;margin-top:8px;padding-top:20px;border-top:1px solid rgba(255,255,255,.06)}

/* SEARCH & FILTER BAR */
.bar{display:flex;gap:10px;align-items:center;margin-bottom:22px;flex-wrap:wrap}
.search-box{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:9px 14px;flex:1;min-width:200px}
.search-box svg{width:15px;height:15px;stroke:rgba(255,255,255,.3);fill:none;stroke-width:2;flex-shrink:0}
.search-box input{background:none;border:none;outline:none;color:#fff;font-size:.9rem;width:100%}
.search-box input::placeholder{color:rgba(255,255,255,.2)}
.filter-sel{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:9px 12px;color:rgba(255,255,255,.6);font-size:.82rem;font-family:var(--fb);outline:none}
.filter-sel option{background:#1a1a1a}

/* SEGUIMIENTO */
.timeline{display:flex;flex-direction:column;gap:0;margin-top:12px;padding-left:8px}
.tl-item{display:flex;gap:14px;padding-bottom:20px;position:relative}
.tl-item::before{content:'';position:absolute;left:8px;top:20px;bottom:0;width:1px;background:rgba(255,255,255,.07)}
.tl-item:last-child::before{display:none}
.tl-dot{width:17px;height:17px;border-radius:50%;background:var(--r);flex-shrink:0;margin-top:3px;border:2.5px solid var(--carbon);position:relative;z-index:1}
.tl-dot.note{background:var(--gold)}
.tl-dot.ok{background:var(--verde)}
.tl-content{flex:1}
.tl-date{font-family:var(--fc);font-size:.62rem;letter-spacing:1px;color:rgba(255,255,255,.28);margin-bottom:3px}
.tl-text{font-size:.87rem;color:rgba(255,255,255,.72);line-height:1.55}
.tl-tag{display:inline-block;font-family:var(--fc);font-size:.58rem;letter-spacing:1px;text-transform:uppercase;font-weight:700;padding:2px 7px;border-radius:100px;margin-top:4px}

/* QUICK NOTE */
.quick-note{display:flex;gap:8px;margin-top:12px}
.quick-note input{flex:1;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.07);border-radius:8px;padding:10px 12px;color:#fff;font-size:.87rem;outline:none}
.quick-note input:focus{border-color:var(--r)}
.quick-note input::placeholder{color:rgba(255,255,255,.2)}

/* KPI MINI */
.mini-kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:24px}
.mk{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:14px;text-align:center}
.mk-n{font-family:var(--fh);font-size:1.4rem;font-weight:900;color:var(--r);line-height:1}
.mk-l{font-family:var(--fc);font-size:.6rem;letter-spacing:1.5px;text-transform:uppercase;color:rgba(255,255,255,.28);margin-top:4px}

/* SECTION TITLE */
.sec-t{font-family:var(--fh);font-size:1.1rem;font-weight:700;color:#fff;margin-bottom:16px;display:flex;align-items:center;gap:10px}
.sec-t-line{width:3px;height:18px;background:var(--r);border-radius:2px;flex-shrink:0}

/* TABS */
.tabs{display:flex;gap:4px;border-bottom:1px solid rgba(255,255,255,.07);margin-bottom:24px}
.tab{font-family:var(--fc);font-size:.72rem;letter-spacing:1.5px;text-transform:uppercase;font-weight:700;padding:10px 18px;color:rgba(255,255,255,.35);transition:all .2s;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px}
.tab:hover{color:rgba(255,255,255,.65)}
.tab.active{color:#fff;border-bottom-color:var(--r)}

/* EMPTY STATE */
.empty-state{text-align:center;padding:60px 24px;color:rgba(255,255,255,.2)}
.empty-state .ei{font-size:3rem;opacity:.2;margin-bottom:12px}
.empty-state h3{font-family:var(--fh);font-size:1.1rem;margin-bottom:6px}
.empty-state p{font-size:.85rem;color:rgba(255,255,255,.2)}

/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(12px);background:rgba(30,30,30,.95);color:#fff;font-family:var(--fc);font-size:.75rem;letter-spacing:1px;padding:10px 20px;border-radius:100px;opacity:0;transition:all .3s;z-index:9999;border:1px solid rgba(255,255,255,.08);pointer-events:none;white-space:nowrap}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0)}

/* ── RESPONSIVE ── */
@media(max-width:768px){
  .sidebar{transform:translateX(-100%);width:260px}
  .sidebar.open{transform:none}
  .sb-overlay.on{display:block}
  .main{margin-left:0}
  .mob-toggle{display:flex}
  .stats-row{grid-template-columns:1fr 1fr}
  .topbar{padding:0 16px}
  .page-content{padding:20px 16px}
  .fg-row{grid-template-columns:1fr}
  .modal{padding:24px 18px}
}
@media(max-width:480px){
  .stats-row{grid-template-columns:1fr}
  .bar{flex-direction:column}
  .search-box{min-width:100%}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo"><div class="lm">PC</div><div class="lw">PORCI<em>CENTRO</em></div></div>
    <div class="login-title">Panel CRM</div>
    <div class="login-sub">Acceso restringido. Ingresa tus credenciales.</div>
    <div class="lf"><label>Usuario</label><input type="text" id="l-user" placeholder="Usuario" autocomplete="username" onkeydown="if(event.key==='Enter')doLogin()"></div>
    <div class="lf"><label>Contrasena</label><input type="password" id="l-pass" placeholder="Contrasena" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()"></div>
    <div class="login-err" id="l-err">Usuario o contrasena incorrectos.</div>
    <button class="login-btn" id="login-btn" onclick="doLogin()"><span class="login-spinner" id="login-spin"></span>Ingresar</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="sb-overlay" id="sb-overlay" onclick="closeSidebar()"></div>
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sb-logo"><div class="sb-lm">PC</div><div class="sb-lw">PORCI<em>CENTRO</em></div></div>
    <nav class="sb-nav">
      <div class="sb-label">Principal</div>
      <button class="sb-link active" onclick="goPage('dashboard',this)"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Dashboard</button>
      <button class="sb-link" onclick="goPage('clientes',this)"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>Clientes</button>
      <button class="sb-link" onclick="goPage('pedidos',this)"><svg viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>Pedidos</button>
      <button class="sb-link" onclick="goPage('seguimiento',this)"><svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>Seguimiento</button>
      <div class="sb-label">Herramientas</div>
      <button class="sb-link" onclick="exportCSV('clientes')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Exportar Clientes</button>
      <button class="sb-link" onclick="exportCSV('pedidos')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Exportar Pedidos</button>
      <a class="sb-link" href="index.html" target="_blank"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Ir al Sitio Web</a>
      <a class="sb-link" href="https://wa.me/50248890091" target="_blank" rel="noopener"><svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/></svg>WhatsApp</a>
    </nav>
    <div class="sb-ft">
      <div class="sb-user"><div class="sb-avatar" id="sb-av">A</div><div><div class="sb-uname" id="sb-uname">Admin</div><div class="sb-urole">Administrador</div></div></div>
      <button class="logout-btn" onclick="doLogout()"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Cerrar Sesion</button>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main">
    <div class="topbar">
      <div class="topbar-left">
        <button class="mob-toggle" onclick="toggleSidebar()"><svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
        <div class="topbar-title" id="page-title">Dashboard</div>
      </div>
      <div class="topbar-actions">
        <button class="btn btn-prim" id="topbar-cta" onclick="openModal('cliente')">
          <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>Nuevo Cliente
        </button>
      </div>
    </div>
    <div class="page-content" id="page-content"></div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-bg" id="modal-bg" onclick="closeModal(event)">
  <div class="modal" id="modal-box"></div>
</div>

<div class="toast" id="toast"></div>

<script>
// ─── DATA STORE (localStorage) ─────────────────────────────
function loadData(k){ try{return JSON.parse(localStorage.getItem('pc_crm_'+k)||'[]')}catch{return []} }
function saveData(k,v){ localStorage.setItem('pc_crm_'+k,JSON.stringify(v)) }
function genId(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6) }
function now(){ return new Date().toLocaleString('es-GT',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}) }
function today(){ return new Date().toLocaleDateString('es-GT',{day:'2-digit',month:'short',year:'numeric'}) }

let STATE = { page:'dashboard', cliente_filter:'', pedido_filter:'' };

// ─── LOGIN (server-side auth via Netlify Function) ──────────
async function doLogin(){
  const u=document.getElementById('l-user').value.trim();
  const p=document.getElementById('l-pass').value;
  const err=document.getElementById('l-err');
  const btn=document.getElementById('login-btn');
  const spinner=document.getElementById('login-spin');

  if(!u||!p){
    err.textContent='Por favor ingresa usuario y contrasena.';
    err.style.display='block';
    return;
  }

  // Show loading state
  btn.disabled=true;
  spinner.style.display='inline-block';
  err.style.display='none';

  // Verificación de credenciales
  await new Promise(r => setTimeout(r, 600));
  const USERS = { 'erik': '1234' };
  if (USERS[u.toLowerCase()] && USERS[u.toLowerCase()] === p) {
    const displayUser = u.charAt(0).toUpperCase() + u.slice(1).toLowerCase();
    sessionStorage.setItem('pc_crm_auth', displayUser);
    document.getElementById('login-screen').classList.add('out');
    setTimeout(()=>{
      document.getElementById('login-screen').style.display='none';
      document.getElementById('app').classList.add('on');
      renderPage('dashboard');
    },420);
    document.getElementById('sb-av').textContent=displayUser[0].toUpperCase();
    document.getElementById('sb-uname').textContent=displayUser;
  } else {
    err.textContent='Usuario o contraseña incorrectos.';
    err.style.display='block';
  }

  btn.disabled=false;
  spinner.style.display='none';
}

function doLogout(){
  sessionStorage.removeItem('pc_crm_auth');
  sessionStorage.removeItem('pc_crm_token');
  document.getElementById('app').classList.remove('on');
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('login-screen').classList.remove('out');
  document.getElementById('l-pass').value='';
}

// Check if already authenticated
if(sessionStorage.getItem('pc_crm_auth')){
  const u = sessionStorage.getItem('pc_crm_auth');
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').classList.add('on');
  document.getElementById('sb-av').textContent=u[0].toUpperCase();
  document.getElementById('sb-uname').textContent=u.charAt(0).toUpperCase()+u.slice(1);
  setTimeout(()=>renderPage('dashboard'),0);
}

// ─── MOBILE SIDEBAR ─────────────────────────────────────────
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sb-overlay').classList.toggle('on');
}
function closeSidebar(){
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sb-overlay').classList.remove('on');
}

// ─── NAVIGATION ─────────────────────────────────────────────
function goPage(page,btn){
  STATE.page=page;
  document.querySelectorAll('.sb-link').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  const titles={dashboard:'Dashboard',clientes:'Clientes',pedidos:'Pedidos',seguimiento:'Seguimiento'};
  document.getElementById('page-title').textContent=titles[page]||page;
  const ctaLabels={clientes:'Nuevo Cliente',pedidos:'Nuevo Pedido',dashboard:'Nuevo Cliente',seguimiento:'Agregar Nota'};
  const ctaActions={clientes:"openModal('cliente')",pedidos:"openModal('pedido')",dashboard:"openModal('cliente')",seguimiento:"openModal('nota')"};
  const ctaBtn=document.getElementById('topbar-cta');
  ctaBtn.setAttribute('onclick',ctaActions[page]||'');
  ctaBtn.innerHTML=`<svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:#fff;fill:none;stroke-width:2;stroke-linecap:round"><path d="M12 5v14M5 12h14"/></svg>${ctaLabels[page]||'Nuevo'}`;
  renderPage(page);
  closeSidebar();
}

// ─── RENDER ─────────────────────────────────────────────────
function renderPage(page){
  const c=document.getElementById('page-content');
  if(page==='dashboard') c.innerHTML=renderDashboard();
  else if(page==='clientes') c.innerHTML=renderClientes();
  else if(page==='pedidos') c.innerHTML=renderPedidos();
  else if(page==='seguimiento') c.innerHTML=renderSeguimiento();
}

// ─── DASHBOARD ──────────────────────────────────────────────
function renderDashboard(){
  const clientes=loadData('clientes');
  const pedidos=loadData('pedidos');
  const total=pedidos.reduce((s,p)=>s+(p.total||0),0);
  const activos=clientes.filter(c=>c.estado==='Activo').length;
  const pendientes=pedidos.filter(p=>p.estado==='Pendiente').length;
  const entregados=pedidos.filter(p=>p.estado==='Entregado').length;
  const recientes=clientes.slice(-5).reverse();
  const recPed=pedidos.slice(-5).reverse();

  return `
  <div class="stats-row">
    <div class="stat-card"><div class="sc-val">${clientes.length}</div><div class="sc-lbl">Clientes Totales</div>${clientes.length?`<div class="sc-trend trend-up">${activos} activos</div>`:''}</div>
    <div class="stat-card"><div class="sc-val">${pedidos.length}</div><div class="sc-lbl">Pedidos Registrados</div>${pendientes?`<div class="sc-trend trend-new">${pendientes} pendientes</div>`:''}</div>
    <div class="stat-card"><div class="sc-val">${entregados}</div><div class="sc-lbl">Pedidos Entregados</div></div>
    <div class="stat-card"><div class="sc-val">Q${total.toLocaleString('es-GT',{minimumFractionDigits:2})}</div><div class="sc-lbl">Ventas Totales</div></div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
    <div class="card">
      <div class="sec-t"><div class="sec-t-line"></div>Clientes Recientes</div>
      ${recientes.length?`<div class="tbl-wrap"><table class="tbl"><thead><tr><th>Nombre</th><th>Tel</th><th>Estado</th></tr></thead><tbody>${recientes.map(c=>`<tr><td><strong>${esc(c.nombre)}</strong></td><td>${esc(c.tel)}</td><td><span class="badge badge-${c.estado==='Activo'?'ok':'warn'}">${esc(c.estado)}</span></td></tr>`).join('')}</tbody></table></div>`:`<div class="empty-state"><div class="ei">&#x1F465;</div><h3>Sin clientes</h3><p>Agrega tu primer cliente con el boton de arriba</p></div>`}
    </div>
    <div class="card">
      <div class="sec-t"><div class="sec-t-line"></div>Pedidos Recientes</div>
      ${recPed.length?`<div class="tbl-wrap"><table class="tbl"><thead><tr><th>Cliente</th><th>Total</th><th>Estado</th></tr></thead><tbody>${recPed.map(p=>`<tr><td><strong>${esc(p.cliente)}</strong></td><td>Q${(p.total||0).toFixed(2)}</td><td><span class="badge badge-${p.estado==='Entregado'?'ok':p.estado==='Pendiente'?'warn':'hot'}">${esc(p.estado)}</span></td></tr>`).join('')}</tbody></table></div>`:`<div class="empty-state"><div class="ei">&#x1F4E6;</div><h3>Sin pedidos</h3><p>Registra el primer pedido</p></div>`}
    </div>
  </div>`;
}

// ─── CLIENTES ───────────────────────────────────────────────
function renderClientes(){
  const clientes=loadData('clientes');
  const q=STATE.cliente_filter.toLowerCase();
  const fil=q?clientes.filter(c=>c.nombre.toLowerCase().includes(q)||c.tel.includes(q)||(c.tipo||'').toLowerCase().includes(q)):clientes;
  return `
  <div class="bar">
    <div class="search-box"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input placeholder="Buscar cliente por nombre, telefono o tipo..." value="${STATE.cliente_filter}" oninput="STATE.cliente_filter=this.value;renderPage('clientes')"></div>
    <select class="filter-sel" onchange="STATE.cliente_filter=this.value;renderPage('clientes')"><option value="">Todos los tipos</option><option>Restaurante</option><option>Carniceria</option><option>Hogar</option><option>Mayorista</option><option>Otro</option></select>
  </div>
  <div class="tbl-wrap">
    <table class="tbl">
      <thead><tr><th>#</th><th>Nombre</th><th>Telefono</th><th>Tipo</th><th>Estado</th><th>Direccion</th><th>Notas</th><th>Acciones</th></tr></thead>
      <tbody>${fil.length?fil.map((c,i)=>`<tr>
        <td style="color:rgba(255,255,255,.3);font-family:var(--fc);font-size:.7rem">${clientes.length-clientes.indexOf(c)}</td>
        <td><strong style="color:#fff">${esc(c.nombre)}</strong></td>
        <td><a href="https://wa.me/502${c.tel.replace(/\D/g,'')}" target="_blank" rel="noopener" style="color:#25D366;font-family:var(--fc);font-size:.82rem">${esc(c.tel)}</a></td>
        <td><span class="badge badge-new">${esc(c.tipo||'--')}</span></td>
        <td><span class="badge badge-${c.estado==='Activo'?'ok':'warn'}">${esc(c.estado||'--')}</span></td>
        <td style="color:rgba(255,255,255,.5);font-size:.82rem;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(c.dir||'--')}</td>
        <td style="color:rgba(255,255,255,.4);font-size:.8rem;max-width:160px">${c.notas?esc(c.notas.substring(0,50))+'...':'--'}</td>
        <td><div style="display:flex;gap:5px">
          <button class="btn btn-sm btn-sec" onclick="editCliente('${c.id}')">Editar</button>
          <button class="btn btn-sm btn-danger" onclick="delCliente('${c.id}')">&#x2715;</button>
        </div></td>
      </tr>`).join(''):`<tr><td colspan="8"><div class="empty-state"><div class="ei">&#x1F465;</div><h3>Sin resultados</h3><p>No hay clientes que coincidan</p></div></td></tr>`}
      </tbody>
    </table>
  </div>`;
}

// ─── PEDIDOS ────────────────────────────────────────────────
function renderPedidos(){
  const pedidos=loadData('pedidos');
  const q=STATE.pedido_filter.toLowerCase();
  const fil=q?pedidos.filter(p=>p.cliente.toLowerCase().includes(q)||(p.detalle||'').toLowerCase().includes(q)||(p.estado||'').toLowerCase().includes(q)):pedidos;
  return `
  <div class="bar">
    <div class="search-box"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input placeholder="Buscar por cliente, detalle o estado..." value="${STATE.pedido_filter}" oninput="STATE.pedido_filter=this.value;renderPage('pedidos')"></div>
    <select class="filter-sel" onchange="STATE.pedido_filter=this.value;renderPage('pedidos')"><option value="">Todos los estados</option><option>Pendiente</option><option>En camino</option><option>Entregado</option><option>Cancelado</option></select>
  </div>
  <div class="tbl-wrap"><table class="tbl"><thead><tr><th>#</th><th>Fecha</th><th>Cliente</th><th>Detalle</th><th>Total</th><th>Estado</th><th>Acciones</th></tr></thead>
  <tbody>${fil.length?fil.slice().reverse().map((p,i)=>`<tr>
    <td style="color:rgba(255,255,255,.3);font-family:var(--fc);font-size:.7rem">${pedidos.indexOf(p)+1}</td>
    <td style="font-family:var(--fc);font-size:.75rem;color:rgba(255,255,255,.4)">${esc(p.fecha||'--')}</td>
    <td><strong style="color:#fff">${esc(p.cliente)}</strong></td>
    <td style="color:rgba(255,255,255,.5);font-size:.82rem;max-width:180px">${p.detalle?esc(p.detalle.substring(0,60)):'--'}</td>
    <td><strong style="color:var(--r);font-family:var(--fh)">Q${(p.total||0).toFixed(2)}</strong></td>
    <td><span class="badge badge-${p.estado==='Entregado'?'ok':p.estado==='Pendiente'?'warn':p.estado==='En camino'?'new':'hot'}">${esc(p.estado)}</span></td>
    <td><div style="display:flex;gap:5px">
      <button class="btn btn-sm btn-sec" onclick="editPedido('${p.id}')">Editar</button>
      <button class="btn btn-sm btn-danger" onclick="delPedido('${p.id}')">&#x2715;</button>
    </div></td>
  </tr>`).join(''):`<tr><td colspan="7"><div class="empty-state"><div class="ei">&#x1F4E6;</div><h3>Sin pedidos</h3><p>Registra el primer pedido</p></div></td></tr>`}
  </tbody></table></div>`;
}

// ─── SEGUIMIENTO ────────────────────────────────────────────
function renderSeguimiento(){
  const notas=loadData('notas');
  const clientes=loadData('clientes');
  return `
  <div style="display:grid;grid-template-columns:300px 1fr;gap:20px;min-height:500px">
    <div class="card card-sm" style="height:fit-content">
      <div class="sec-t" style="margin-bottom:12px"><div class="sec-t-line"></div>Seleccionar Cliente</div>
      <div id="seg-client-list" style="display:flex;flex-direction:column;gap:5px">
        ${clientes.length?clientes.map(c=>`<button class="sb-link" style="border-radius:8px;margin-left:0;padding-left:12px" id="segcl-${c.id}" onclick="selectSegCliente('${c.id}')">
          <svg viewBox="0 0 24 24" style="width:15px;height:15px;stroke:currentColor;fill:none;stroke-width:2;flex-shrink:0"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>${esc(c.nombre)}
        </button>`).join(''):`<p style="color:rgba(255,255,255,.25);font-size:.82rem;padding:8px">Sin clientes. Agrega uno primero.</p>`}
      </div>
    </div>
    <div class="card" id="seg-panel"><div class="empty-state"><div class="ei">&#x1F446;</div><h3>Selecciona un cliente</h3><p>Para ver o agregar notas de seguimiento</p></div></div>
  </div>`;
}

let currentSegCliente = null;
function selectSegCliente(id){
  currentSegCliente=id;
  document.querySelectorAll('[id^="segcl-"]').forEach(b=>b.classList.remove('active'));
  document.getElementById('segcl-'+id)?.classList.add('active');
  const clientes=loadData('clientes');
  const notas=loadData('notas').filter(n=>n.clienteId===id);
  const c=clientes.find(x=>x.id===id);
  const panel=document.getElementById('seg-panel');
  if(!c){panel.innerHTML='';return;}
  panel.innerHTML=`
    <div class="sec-t" style="margin-bottom:6px"><div class="sec-t-line"></div>${esc(c.nombre)}</div>
    <div class="mini-kpis">
      <div class="mk"><div class="mk-n">${loadData('pedidos').filter(p=>p.clienteId===id).length}</div><div class="mk-l">Pedidos</div></div>
      <div class="mk"><div class="mk-n">Q${loadData('pedidos').filter(p=>p.clienteId===id).reduce((s,p)=>s+(p.total||0),0).toFixed(0)}</div><div class="mk-l">Ventas</div></div>
      <div class="mk"><div class="mk-n">${notas.length}</div><div class="mk-l">Notas</div></div>
    </div>
    <div class="quick-note">
      <input type="text" id="seg-note-input" placeholder="Agregar nota rapida (Enter para guardar)..." onkeydown="if(event.key==='Enter')addNota()">
      <button class="btn btn-prim btn-sm" onclick="addNota()">+ Nota</button>
    </div>
    <div class="timeline" id="seg-timeline" style="margin-top:20px">
      ${notas.length?notas.slice().reverse().map(n=>`
        <div class="tl-item">
          <div class="tl-dot ${n.tipo||''}"></div>
          <div class="tl-content">
            <div class="tl-date">${esc(n.fecha)}</div>
            <div class="tl-text">${esc(n.texto)}</div>
          </div>
        </div>`).join(''):`<p style="color:rgba(255,255,255,.2);font-size:.85rem;margin-top:12px">Sin notas de seguimiento aun.</p>`}
    </div>`;
}

function addNota(){
  const inp=document.getElementById('seg-note-input');
  if(!inp||!inp.value.trim()||!currentSegCliente) return;
  const notas=loadData('notas');
  notas.push({id:genId(),clienteId:currentSegCliente,texto:inp.value.trim(),fecha:now(),tipo:''});
  saveData('notas',notas);
  inp.value='';
  selectSegCliente(currentSegCliente);
  showToast('Nota agregada');
}

// ─── MODAL ──────────────────────────────────────────────────
function openModal(type, id){
  const bg=document.getElementById('modal-bg');
  const box=document.getElementById('modal-box');
  if(type==='cliente'){
    const clientes=loadData('clientes');
    const c=id?clientes.find(x=>x.id===id):{};
    box.innerHTML=`
      <div class="modal-hd"><div class="modal-title">${id?'Editar':'Nuevo'} Cliente</div><button class="modal-close" onclick="closeModal()">&#x2715;</button></div>
      <div class="fg-row"><div class="fg"><label>Nombre completo *</label><input id="mc-nombre" value="${esc(c.nombre||'')}" placeholder="Nombre del cliente"></div>
      <div class="fg"><label>Telefono *</label><input id="mc-tel" value="${esc(c.tel||'')}" placeholder="+502 0000-0000"></div></div>
      <div class="fg-row"><div class="fg"><label>Tipo de cliente</label><select id="mc-tipo"><option ${!c.tipo?'selected':''}>Seleccionar</option><option ${c.tipo==='Restaurante'?'selected':''}>Restaurante</option><option ${c.tipo==='Carniceria'?'selected':''}>Carniceria</option><option ${c.tipo==='Hogar'?'selected':''}>Hogar</option><option ${c.tipo==='Mayorista'?'selected':''}>Mayorista</option><option ${c.tipo==='Otro'?'selected':''}>Otro</option></select></div>
      <div class="fg"><label>Estado</label><select id="mc-estado"><option ${c.estado==='Activo'||!c.estado?'selected':''}>Activo</option><option ${c.estado==='Inactivo'?'selected':''}>Inactivo</option><option ${c.estado==='Potencial'?'selected':''}>Potencial</option></select></div></div>
      <div class="fg"><label>Direccion de entrega</label><input id="mc-dir" value="${esc(c.dir||'')}" placeholder="Zona, colonia, direccion"></div>
      <div class="fg"><label>Email</label><input id="mc-email" type="email" value="${esc(c.email||'')}" placeholder="correo@ejemplo.com"></div>
      <div class="fg"><label>Notas / Preferencias</label><textarea id="mc-notas" placeholder="Pedidos habituales, horarios preferidos, cortes favoritos...">${esc(c.notas||'')}</textarea></div>
      <div class="modal-ft"><button class="btn btn-sec" onclick="closeModal()">Cancelar</button><button class="btn btn-prim" onclick="saveCliente('${id||''}')">Guardar Cliente</button></div>`;
  } else if(type==='pedido'){
    const pedidos=loadData('pedidos');
    const clientes=loadData('clientes');
    const p=id?pedidos.find(x=>x.id===id):{};
    box.innerHTML=`
      <div class="modal-hd"><div class="modal-title">${id?'Editar':'Nuevo'} Pedido</div><button class="modal-close" onclick="closeModal()">&#x2715;</button></div>
      <div class="fg"><label>Cliente *</label><select id="mp-cliente"><option value="">Seleccionar cliente</option>${clientes.map(c=>`<option value="${c.id}" ${(p.clienteId===c.id)?'selected':''}>${esc(c.nombre)}</option>`).join('')}</select></div>
      <div class="fg"><label>Detalle del pedido *</label><textarea id="mp-detalle" placeholder="Ej: 3lb costilla, 2lb lomo, 1lb chicharron...">${esc(p.detalle||'')}</textarea></div>
      <div class="fg-row">
        <div class="fg"><label>Total (Q) *</label><input id="mp-total" type="number" min="0" step="0.5" value="${p.total||''}" placeholder="0.00"></div>
        <div class="fg"><label>Estado</label><select id="mp-estado"><option ${!p.estado||p.estado==='Pendiente'?'selected':''}>Pendiente</option><option ${p.estado==='En camino'?'selected':''}>En camino</option><option ${p.estado==='Entregado'?'selected':''}>Entregado</option><option ${p.estado==='Cancelado'?'selected':''}>Cancelado</option></select></div>
      </div>
      <div class="fg"><label>Fecha de entrega</label><input id="mp-fecha" type="date" value="${p.fechaEnt||''}"></div>
      <div class="fg"><label>Notas del pedido</label><textarea id="mp-notas" placeholder="Instrucciones especiales, hora de entrega...">${esc(p.notas||'')}</textarea></div>
      <div class="modal-ft"><button class="btn btn-sec" onclick="closeModal()">Cancelar</button><button class="btn btn-prim" onclick="savePedido('${id||''}')">Guardar Pedido</button></div>`;
  } else if(type==='nota'){
    const clientes=loadData('clientes');
    box.innerHTML=`
      <div class="modal-hd"><div class="modal-title">Agregar Nota</div><button class="modal-close" onclick="closeModal()">&#x2715;</button></div>
      <div class="fg"><label>Cliente</label><select id="mn-cliente"><option value="">Seleccionar</option>${clientes.map(c=>`<option value="${c.id}">${esc(c.nombre)}</option>`).join('')}</select></div>
      <div class="fg"><label>Nota *</label><textarea id="mn-texto" placeholder="Escribe la nota de seguimiento..."></textarea></div>
      <div class="modal-ft"><button class="btn btn-sec" onclick="closeModal()">Cancelar</button><button class="btn btn-prim" onclick="saveNota()">Guardar Nota</button></div>`;
  }
  bg.classList.add('on');
}

function closeModal(e){
  if(e&&e.target!==document.getElementById('modal-bg')) return;
  document.getElementById('modal-bg').classList.remove('on');
}

function saveCliente(id){
  const nombre=document.getElementById('mc-nombre').value.trim();
  const tel=document.getElementById('mc-tel').value.trim();
  if(!nombre||!tel){showToast('Nombre y telefono son requeridos');return;}
  const clientes=loadData('clientes');
  const obj={id:id||genId(),nombre,tel,tipo:document.getElementById('mc-tipo').value,estado:document.getElementById('mc-estado').value,dir:document.getElementById('mc-dir').value.trim(),email:document.getElementById('mc-email').value.trim(),notas:document.getElementById('mc-notas').value.trim(),creado:id?clientes.find(x=>x.id===id)?.creado:today()};
  if(id){const i=clientes.findIndex(x=>x.id===id);if(i>-1)clientes[i]=obj;}else{clientes.push(obj);}
  saveData('clientes',clientes);
  document.getElementById('modal-bg').classList.remove('on');
  renderPage(STATE.page);
  showToast(id?'Cliente actualizado':'Cliente agregado');
}

function editCliente(id){openModal('cliente',id);}
function delCliente(id){
  if(!confirm('Eliminar este cliente?')) return;
  const clientes=loadData('clientes').filter(x=>x.id!==id);
  saveData('clientes',clientes);
  renderPage(STATE.page);
  showToast('Cliente eliminado');
}

function savePedido(id){
  const clienteId=document.getElementById('mp-cliente').value;
  const detalle=document.getElementById('mp-detalle').value.trim();
  const total=parseFloat(document.getElementById('mp-total').value)||0;
  if(!clienteId||!detalle){showToast('Cliente y detalle son requeridos');return;}
  const clientes=loadData('clientes');
  const c=clientes.find(x=>x.id===clienteId);
  const pedidos=loadData('pedidos');
  const obj={id:id||genId(),clienteId,cliente:c?c.nombre:'Desconocido',detalle,total,estado:document.getElementById('mp-estado').value,fechaEnt:document.getElementById('mp-fecha').value,notas:document.getElementById('mp-notas').value.trim(),fecha:id?pedidos.find(x=>x.id===id)?.fecha:today()};
  if(id){const i=pedidos.findIndex(x=>x.id===id);if(i>-1)pedidos[i]=obj;}else{pedidos.push(obj);}
  saveData('pedidos',pedidos);
  document.getElementById('modal-bg').classList.remove('on');
  renderPage(STATE.page);
  showToast(id?'Pedido actualizado':'Pedido registrado');
}

function editPedido(id){openModal('pedido',id);}
function delPedido(id){
  if(!confirm('Eliminar este pedido?')) return;
  saveData('pedidos',loadData('pedidos').filter(x=>x.id!==id));
  renderPage(STATE.page);
  showToast('Pedido eliminado');
}

function saveNota(){
  const clienteId=document.getElementById('mn-cliente').value;
  const texto=document.getElementById('mn-texto').value.trim();
  if(!clienteId||!texto){showToast('Cliente y nota son requeridos');return;}
  const notas=loadData('notas');
  notas.push({id:genId(),clienteId,texto,fecha:now(),tipo:''});
  saveData('notas',notas);
  document.getElementById('modal-bg').classList.remove('on');
  renderPage(STATE.page);
  showToast('Nota guardada');
}

// ─── EXPORT CSV ─────────────────────────────────────────────
function exportCSV(type){
  let csv='', filename='';
  if(type==='clientes'){
    const data=loadData('clientes');
    if(!data.length){showToast('No hay clientes para exportar');return;}
    csv='Nombre,Telefono,Tipo,Estado,Direccion,Email,Notas,Fecha Creacion\n';
    data.forEach(c=>{
      csv+=`"${(c.nombre||'').replace(/"/g,'""')}","${c.tel||''}","${c.tipo||''}","${c.estado||''}","${(c.dir||'').replace(/"/g,'""')}","${c.email||''}","${(c.notas||'').replace(/"/g,'""')}","${c.creado||''}"\n`;
    });
    filename='porcicentro_clientes.csv';
  } else if(type==='pedidos'){
    const data=loadData('pedidos');
    if(!data.length){showToast('No hay pedidos para exportar');return;}
    csv='Fecha,Cliente,Detalle,Total,Estado,Fecha Entrega,Notas\n';
    data.forEach(p=>{
      csv+=`"${p.fecha||''}","${(p.cliente||'').replace(/"/g,'""')}","${(p.detalle||'').replace(/"/g,'""')}","Q${(p.total||0).toFixed(2)}","${p.estado||''}","${p.fechaEnt||''}","${(p.notas||'').replace(/"/g,'""')}"\n`;
    });
    filename='porcicentro_pedidos.csv';
  }
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=filename;
  document.body.appendChild(a);a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('Archivo CSV descargado');
}

// ─── HTML ESCAPE (XSS prevention) ──────────────────────────
function esc(str){
  if(!str) return '';
  const d=document.createElement('div');
  d.textContent=str;
  return d.innerHTML;
}

// ─── TOAST ──────────────────────────────────────────────────
let _tt;
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('on');
  clearTimeout(_tt);_tt=setTimeout(()=>t.classList.remove('on'),2600);
}

// ─── KEYBOARD ───────────────────────────────────────────────
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    document.getElementById('modal-bg').classList.remove('on');
    closeSidebar();
  }
});
</script>
</body>
</html>
